<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Org Chart â€” Lightweight, JSON-driven</title>
  <!-- Tailwind CDN (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Hide scrollbars in the canvas container (still scrollable) */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header / Controls -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-semibold">Org Chart</h1>
      <div class="grow"></div>
      <label class="inline-flex items-center gap-2 text-sm">
        <span class="hidden sm:inline">Node size</span>
        <input id="nodeWidth" type="range" min="160" max="320" value="220" class="accent-slate-700">
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <span class="hidden sm:inline">Spacing</span>
        <input id="hGap" type="range" min="24" max="120" value="48" class="accent-slate-700">
      </label>
      <button id="fitBtn" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Fit to width</button>
      <button id="expandAllBtn" class="px-3 py-1.5 rounded-xl bg-slate-100 text-slate-900 text-sm border hover:bg-slate-200">Expand all</button>
      <button id="collapseAllBtn" class="px-3 py-1.5 rounded-xl bg-slate-100 text-slate-900 text-sm border hover:bg-slate-200">Collapse all</button>
    </div>
  </header>

  <!-- Import / Editor Panel -->
  <section class="max-w-7xl mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="bg-white rounded-2xl shadow p-4 border border-slate-200">
      <div class="flex items-center gap-3 mb-3">
        <h2 class="font-semibold">Data (JSON)</h2>
        <div class="grow"></div>
        <input id="fileInput" type="file" accept="application/json" class="block text-sm" />
        <button id="loadBtn" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Load</button>
        <button id="sampleBtn" class="px-3 py-1.5 rounded-xl bg-slate-100 text-slate-900 text-sm border hover:bg-slate-200">Sample</button>
      </div>
      <p class="text-xs text-slate-500 mb-2">Schema: array of nodes <code>{ id, name, title, managerId, department?, photo? }</code>. Roots have <code>managerId: null</code>.</p>
      <textarea id="jsonInput" class="w-full h-56 font-mono text-sm p-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300" placeholder='[
  {"id": "1", "name": "CEO", "title": "Chief Executive Officer", "managerId": null},
  {"id": "2", "name": "CTO", "title": "VP Technology", "managerId": "1"}
]'></textarea>
      <div class="flex items-center gap-3 mt-3">
        <input id="rootFilter" type="text" class="flex-1 rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder="Optional: start chart at a specific id (subtree)" />
        <button id="renderBtn" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">Render</button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 border border-slate-200">
      <h2 class="font-semibold mb-3">Quick Tips</h2>
      <ul class="text-sm space-y-1 list-disc pl-5 text-slate-600">
        <li>Click a node to collapse/expand its subtree.</li>
        <li>Use the sliders to adjust node width and spacing.</li>
        <li>Paste your JSON and press <em>Render</em> (or load a file).</li>
        <li>Use the <em>start chart at id</em> box to focus on a subtree.</li>
      </ul>
      <div class="mt-3 text-xs text-slate-500">
        Minimal, dependency-free layout algorithm; no frameworks required. You can host this as a static file.
      </div>
    </div>
  </section>

  <!-- Chart Canvas -->
  <section class="px-2 pb-8">
    <div id="canvasWrap" class="bg-white border border-slate-200 rounded-2xl shadow mx-auto max-w-7xl overflow-auto no-scrollbar relative">
      <svg id="wires" class="absolute inset-0 pointer-events-none"></svg>
      <div id="nodesLayer" class="relative"></div>
    </div>
  </section>

  <template id="nodeTemplate">
    <div class="node-card select-none cursor-pointer bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow transition p-3 w-[220px]">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl overflow-hidden bg-slate-100 flex items-center justify-center text-slate-400 text-xs shrink-0">
          <img class="h-full w-full object-cover hidden" />
          <span class="fallback">ðŸ‘¤</span>
        </div>
        <div class="min-w-0">
          <div class="font-semibold truncate name"></div>
          <div class="text-xs text-slate-500 truncate title"></div>
        </div>
      </div>
      <div class="mt-2 text-[11px] text-slate-500 flex items-center gap-2">
        <span class="badge hidden px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200 dept"></span>
        <span class="count hidden ml-auto px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100"></span>
      </div>
    </div>
  </template>

  <script>
    // ---------- Utility: Parse & Validate ----------
    function parseJSON(input) {
      try { return JSON.parse(input); } catch (e) {
        alert('Invalid JSON: ' + e.message); throw e;
      }
    }

    function buildForest(nodes) {
      const byId = new Map(nodes.map(n => [String(n.id), { ...n, id: String(n.id) }]));
      const children = new Map([...byId.keys()].map(k => [k, []]));
      const hasParent = new Set();

      for (const n of byId.values()) {
        if (n.managerId !== null && n.managerId !== undefined && byId.has(String(n.managerId))) {
          const pid = String(n.managerId);
          children.get(pid).push(n.id);
          hasParent.add(n.id);
        }
      }
      const roots = [...byId.keys()].filter(k => !hasParent.has(k));
      return { byId, children, roots };
    }

    // ---------- Layout Algorithm (simple DFS, tidy-ish) ----------
    function layoutForest(forest, opts) {
      const { byId, children, roots } = forest;
      const nodeW = opts.nodeW, nodeH = opts.nodeH, hGap = opts.hGap, vGap = opts.vGap;

      // Compute subtree sizes (#leaf slots) to place siblings evenly
      const subtreeSlots = new Map();
      function computeSlots(id) {
        const ch = children.get(id) || [];
        if (!ch.length) { subtreeSlots.set(id, 1); return 1; }
        const sum = ch.map(computeSlots).reduce((a,b)=>a+b,0);
        subtreeSlots.set(id, sum); return sum;
      }

      const order = [];
      function placeSubtree(id, xOffset, depth, coords) {
        const ch = children.get(id) || [];
        const slots = subtreeSlots.get(id) || 1;
        // The center x of this node is the center of its slots
        const myCenterSlot = xOffset + (slots - 1) / 2;
        const x = myCenterSlot * (nodeW + hGap);
        const y = depth * (nodeH + vGap);
        coords.set(id, { x, y });
        order.push(id);
        // Place children left-to-right within this subtree
        let childOffset = xOffset;
        for (const c of ch) {
          const cSlots = subtreeSlots.get(c) || 1;
          placeSubtree(c, childOffset, depth + 1, coords);
          childOffset += cSlots;
        }
      }

      // For multiple roots, place them side-by-side
      const coords = new Map();
      let xCursor = 0;
      let maxDepth = 0;
      const allRoots = roots.length ? roots : [...byId.keys()].slice(0,1);
      for (const r of allRoots) {
        computeSlots(r);
        placeSubtree(r, xCursor, 0, coords);
        xCursor += subtreeSlots.get(r) || 1;
      }
      // Determine bounds and depth
      for (const { y } of coords.values()) {
        maxDepth = Math.max(maxDepth, Math.round(y / (nodeH + vGap)));
      }
      const totalSlots = xCursor || 1;
      const width = totalSlots * (nodeW + hGap) - hGap;
      const height = (maxDepth + 1) * (nodeH + vGap) - vGap;
      return { coords, width, height, order };
    }

    // ---------- Rendering ----------
    const nodesLayer = document.getElementById('nodesLayer');
    const wires = document.getElementById('wires');
    const canvasWrap = document.getElementById('canvasWrap');

    let currentData = [];
    let forest = null;
    let collapsed = new Set();

    const state = {
      nodeW: 220,
      nodeH: 92,
      hGap: 48,
      vGap: 80,
    };

    function renderChart(startId=null) {
      if (!currentData?.length) return;
      // Build forest and optionally focus on a subtree
      forest = buildForest(currentData);
      if (startId && forest.byId.has(String(startId))) {
        const id = String(startId);
        const subChildren = new Map();
        const byId = new Map();
        function collect(id) {
          const node = forest.byId.get(id);
          byId.set(id, node);
          const ch = forest.children.get(id) || [];
          subChildren.set(id, ch.slice());
          for (const c of ch) collect(c);
        }
        collect(id);
        forest = { byId, children: subChildren, roots: [id] };
      }

      // Remove hidden subtrees from children map (based on collapsed set)
      const prunedChildren = new Map();
      for (const [id, ch] of forest.children.entries()) {
        prunedChildren.set(id, collapsed.has(id) ? [] : ch.filter(c => !isCollapsedAncestor(c)));
      }
      const prunedForest = { byId: forest.byId, children: prunedChildren, roots: forest.roots };

      const { coords, width, height } = layoutForest(prunedForest, state);

      // Resize canvas layers
      nodesLayer.style.width = width + 'px';
      nodesLayer.style.height = height + 'px';
      wires.setAttribute('width', width);
      wires.setAttribute('height', height);

      // Clear
      nodesLayer.innerHTML = '';
      wires.innerHTML = '';

      // Draw connectors (edges)
      for (const [pid, ch] of prunedForest.children.entries()) {
        const p = coords.get(pid);
        if (!p) continue;
        for (const cid of ch) {
          const c = coords.get(cid);
          if (!c) continue;
          const x1 = p.x + state.nodeW/2, y1 = p.y + state.nodeH; // parent bottom center
          const x2 = c.x + state.nodeW/2, y2 = c.y;               // child top center
          const midY = (y1 + y2) / 2;
          const path = document.createElementNS('http://www.w3.org/2000/svg','path');
          path.setAttribute('d', `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`);
          path.setAttribute('class', 'stroke-slate-300');
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke', 'currentColor');
          path.setAttribute('stroke-width', '1.5');
          wires.appendChild(path);
        }
      }

      // Draw nodes
      for (const [id, n] of forest.byId.entries()) {
        const pos = coords.get(id);
        if (!pos) continue; // filtered or collapsed away
        const tpl = document.getElementById('nodeTemplate');
        const el = tpl.content.firstElementChild.cloneNode(true);
        el.style.position = 'absolute';
        el.style.left = (pos.x) + 'px';
        el.style.top = (pos.y) + 'px';
        el.style.width = state.nodeW + 'px';
        el.dataset.id = id;

        el.querySelector('.name').textContent = n.name ?? id;
        el.querySelector('.title').textContent = n.title ?? '';
        if (n.department) {
          const d = el.querySelector('.dept');
          d.textContent = n.department;
          d.classList.remove('hidden');
        }
        const countBadge = el.querySelector('.count');
        const chCount = (forest.children.get(id) || []).length;
        if (chCount) { countBadge.textContent = chCount + ' reports'; countBadge.classList.remove('hidden'); }

        const img = el.querySelector('img');
        if (n.photo) {
          img.src = n.photo; img.classList.remove('hidden');
          el.querySelector('.fallback').classList.add('hidden');
        }

        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const nodeId = el.dataset.id;
          if (collapsed.has(nodeId)) collapsed.delete(nodeId); else collapsed.add(nodeId);
          renderChart(startId);
        });

        nodesLayer.appendChild(el);
      }
    }

    function isCollapsedAncestor(id) {
      // Walk up to root; if any ancestor is collapsed, treat this node as hidden
      if (!forest) return false;
      const byId = forest.byId;
      const rev = new Map();
      for (const [pid, arr] of forest.children.entries()) {
        for (const c of arr) rev.set(c, pid);
      }
      let cur = id;
      let guard = 0;
      while (rev.has(cur) && guard++ < 9999) {
        const p = rev.get(cur);
        if (collapsed.has(p)) return true;
        cur = p;
      }
      return false;
    }

    // ---------- Controls Wiring ----------
    const jsonInput = document.getElementById('jsonInput');
    const renderBtn = document.getElementById('renderBtn');
    const loadBtn = document.getElementById('loadBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const fileInput = document.getElementById('fileInput');
    const fitBtn = document.getElementById('fitBtn');
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');
    const rootFilter = document.getElementById('rootFilter');

    renderBtn.addEventListener('click', () => {
      try {
        currentData = parseJSON(jsonInput.value);
        collapsed.clear();
        renderChart(rootFilter.value || null);
      } catch {}
    });

    loadBtn.addEventListener('click', async () => {
      const f = fileInput.files?.[0];
      if (!f) { alert('Choose a JSON file first.'); return; }
      const text = await f.text();
      jsonInput.value = text;
      renderBtn.click();
    });

    sampleBtn.addEventListener('click', () => {
      const sample = [
        { id: '1', name: 'Alex Morgan', title: 'Chief Executive Officer', managerId: null, department: 'Executive' },
        { id: '2', name: 'Priya Shah', title: 'VP, Technology', managerId: '1', department: 'Engineering' },
        { id: '3', name: 'Liam Chen', title: 'VP, Operations', managerId: '1', department: 'Ops' },
        { id: '4', name: 'Maya Rossi', title: 'Director, Platform', managerId: '2', department: 'Engineering' },
        { id: '5', name: 'Jon Park', title: 'Director, Data', managerId: '2', department: 'Engineering' },
        { id: '6', name: 'Sara Ahmed', title: 'Mgr, DevEx', managerId: '4', department: 'Engineering' },
        { id: '7', name: 'Noah Patel', title: 'Staff Eng', managerId: '6', department: 'Engineering' },
        { id: '8', name: 'Ava Brooks', title: 'Mgr, Infra', managerId: '4', department: 'Engineering' },
        { id: '9', name: 'Omar Diallo', title: 'Lead SRE', managerId: '8', department: 'Engineering' },
        { id: '10', name: 'Grace Kim', title: 'Director, CX', managerId: '3', department: 'Ops' },
        { id: '11', name: 'Leo Silva', title: 'Mgr, Support', managerId: '10', department: 'Ops' },
      ];
      jsonInput.value = JSON.stringify(sample, null, 2);
      rootFilter.value = '';
      renderBtn.click();
    });

    fitBtn.addEventListener('click', () => {
      // Fit horizontally
      canvasWrap.scrollTo({ left: 0, top: 0, behavior: 'smooth' });
    });

    // Size sliders
    document.getElementById('nodeWidth').addEventListener('input', (e) => {
      state.nodeW = parseInt(e.target.value, 10) || 220;
      renderChart(rootFilter.value || null);
    });
    document.getElementById('hGap').addEventListener('input', (e) => {
      state.hGap = parseInt(e.target.value, 10) || 48;
      renderChart(rootFilter.value || null);
    });

    expandAllBtn.addEventListener('click', () => { collapsed.clear(); renderChart(rootFilter.value || null); });
    collapseAllBtn.addEventListener('click', () => {
      if (!forest) return;
      collapsed = new Set([...forest.byId.keys()]);
      renderChart(rootFilter.value || null);
    });

    // Initial sample render
    document.getElementById('sampleBtn').click();
  </script>
</body>
</html>
